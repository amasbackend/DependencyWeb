<div class="w-full mx-auto max-w-4xl px-4 py-8">
  <div class="bg-white rounded-lg shadow-lg p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">GitHub 專案匯入</h1>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <p class="text-sm text-gray-700">
        此功能會直接從 GitHub 讀取專案的主要分支程式碼，分析其中的 actors 和 models 關聯，並匯入到資料庫中。
        <br>
        <span class="text-xs text-gray-600">（不需要下載整個專案，直接透過 GitHub API 讀取檔案）</span>
      </p>
    </div>

    <form id="import-form" class="space-y-6">
      <div>
        <label for="owner-input" class="block text-sm font-medium text-gray-700 mb-2">
          Owner (GitHub 使用者或組織名稱)
        </label>
        <input
          type="text"
          id="owner-input"
          name="owner"
          placeholder="例如: AMASTek"
          value="AMASTek"
          required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <p class="mt-1 text-xs text-gray-500">建議: 'AMASTek', 'amashrm'</p>
      </div>

      <div>
        <label for="repo-input" class="block text-sm font-medium text-gray-700 mb-2">
          Repository 名稱
        </label>
        <input
          type="text"
          id="repo-input"
          name="repo"
          placeholder="例如: PrjJieZhou"
          value="PrjJieZhou"
          required
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <p class="mt-1 text-xs text-gray-500">建議: 'PrjJieZhou'</p>
      </div>

      <div>
        <label for="branch-input" class="block text-sm font-medium text-gray-700 mb-2">
          分支名稱 (選填)
        </label>
        <input
          type="text"
          id="branch-input"
          name="branch"
          placeholder="例如: main, master, develop"
          value="master"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <p class="mt-1 text-xs text-gray-500">例如: main, master, develop</p>
      </div>

      <div class="flex items-center space-x-4">
        <button
          type="submit"
          id="import-btn"
          class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 hover:shadow-lg hover:scale-105 active:bg-blue-800 active:scale-95 transition duration-200 text-sm font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
          <span id="import-text">開始匯入</span>
        </button>

        <%= link_to "返回主頁", root_path,
         class: "px-6 py-3 bg-gray-600 text-black rounded-lg shadow-md hover:bg-gray-700 transition duration-200 text-sm font-medium" %>
      </div>

      <!-- 訊息顯示區域 -->
      <div id="message-indicator" class="hidden mt-4 p-4 rounded-lg text-sm font-medium"></div>
    </form>
  </div>
</div>

<!-- 等待中彈出視窗（匯入時顯示，完成後自動消失） -->
<div id="waiting-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50" aria-hidden="true">
  <div class="bg-white rounded-xl shadow-2xl px-8 py-6 flex flex-col items-center gap-4 min-w-[200px]">
    <p id="waiting-modal-message" class="text-gray-800 font-medium">等待中...</p>
    <p class="text-sm text-gray-500 animate-pulse">請稍候</p>
  </div>
</div>

<script>
  function showWaitingModal(message) {
    message = message || '等待中...';
    const modal = document.getElementById('waiting-modal');
    const msgEl = document.getElementById('waiting-modal-message');
    if (modal) modal.classList.remove('hidden');
    if (msgEl) msgEl.textContent = message;
  }

  function hideWaitingModal() {
    const modal = document.getElementById('waiting-modal');
    if (modal) modal.classList.add('hidden');
  }

  function resetImportLoadingIndicators() {
    hideWaitingModal();
    const btn = document.getElementById('import-btn');
    const text = document.getElementById('import-text');
    if (btn) btn.disabled = false;
    if (text) text.textContent = '開始匯入';
  }

  function showMessage(msg, isSuccess) {
    const message = document.getElementById('message-indicator');
    if (!message) return;
    message.textContent = msg;
    message.className = isSuccess
      ? 'mt-4 p-4 rounded-lg text-sm font-medium text-green-600 bg-green-50 border border-green-200'
      : 'mt-4 p-4 rounded-lg text-sm font-medium text-red-600 bg-red-50 border border-red-200';
    message.classList.remove('hidden');
  }

  function attachImportForm() {
    var form = document.getElementById('import-form');
    if (!form) return;
    // 避免重複綁定（Turbo 返回此頁時可能再觸發 turbo:load）
    if (form._importSubmitAttached) return;
    form._importSubmitAttached = true;

    form.addEventListener('submit', function(e) {
      e.preventDefault();

      var owner = document.getElementById('owner-input').value.trim();
      var repo = document.getElementById('repo-input').value.trim();
      var branch = document.getElementById('branch-input').value.trim() || 'main';
      var btn = document.getElementById('import-btn');
      var text = document.getElementById('import-text');
      var messageEl = document.getElementById('message-indicator');

      if (!owner || !repo) {
        showMessage('❌ 請填寫 Owner 和 Repository 名稱', false);
        return;
      }

      btn.disabled = true;
      if (messageEl) messageEl.classList.add('hidden');
      showWaitingModal('匯入中...');

      fetch('<%= code_analysis_index_path %>', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': '<%= form_authenticity_token %>'
        },
        body: JSON.stringify({
          owner: owner,
          repo: repo,
          branch: branch
        })
      })
      .then(function(response) { return response.json(); })
      .then(function(data) {
        hideWaitingModal();
        btn.disabled = false;
        if (text) text.textContent = '開始匯入';
        if (data.success) {
          showMessage('✅ ' + data.message, true);
          if (data.company_id) {
            setTimeout(function() {
              window.location.href = '<%= management_pages_path %>';
            }, 2000);
          }
        } else {
          showMessage('❌ ' + (data.error || '匯入失敗'), false);
        }
      })
      .catch(function(error) {
        hideWaitingModal();
        btn.disabled = false;
        if (text) text.textContent = '開始匯入';
        showMessage('❌ 錯誤: ' + error.message, false);
      });
    });
  }

  document.addEventListener('turbo:before-cache', resetImportLoadingIndicators);
  document.addEventListener('turbo:load', function() {
    resetImportLoadingIndicators();
    attachImportForm();
  });
  document.addEventListener('DOMContentLoaded', attachImportForm);
</script>

