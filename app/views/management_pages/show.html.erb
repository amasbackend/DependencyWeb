<div class="w-full mx-auto">
  <!-- æµ®å‹•å°å¼•åˆ— -->
  <div class="sticky top-0 z-20 bg-white shadow-md py-3 px-6">
    <div class="flex items-center justify-between">
      <!-- å·¦å´ï¼šè¿”å›æŒ‰éˆ• -->
      <%= link_to "â¬… è¿”å›ä¸»é ", management_pages_path, 
        class: "inline-block px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-300 text-sm" %>
      
      <!-- ä¸­é–“ï¼šæ¨™é¡Œ -->
      <h1 class="text-2xl font-bold text-gray-800"><%= @company.name %> Management Pages</h1>
      
      <!-- å³å´ï¼šæœå°‹å’Œç¯©é¸åŠŸèƒ½ -->
      <div class="flex items-center space-x-2">
        <%= form_with url: management_page_path(@company), method: :get, local: true, class: "flex items-center space-x-2" do %>
          <%= label_tag :query, "Search:", class: "sr-only" %>
          <%= text_field_tag :query, params[:query], 
            class: "border border-gray-300 rounded-lg px-3 py-2 w-48 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500",
            placeholder: "æœå°‹..." %>
          <%= submit_tag "Search", 
            class: "bg-blue-600 text-white px-3 py-2 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 text-sm" %>
        <% end %>
        
        <!-- ç¯©é¸æŒ‰éˆ• -->
        <div class="flex items-center space-x-1">
          <%= link_to management_page_path(@company, filter: 'all'), 
            class: "px-3 py-2 rounded-lg text-sm font-medium #{params[:filter] != 'changed' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}" do %>
            å…¨éƒ¨
          <% end %>
          <%= link_to management_page_path(@company, filter: 'changed'), 
            class: "px-3 py-2 rounded-lg text-sm font-medium #{params[:filter] == 'changed' ? 'bg-yellow-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}" do %>
            ğŸ”„ ç•°å‹•æª”æ¡ˆ
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="pt-4 pb-2">
    <div class="flex items-center justify-between bg-gray-50 rounded-lg p-4">
      <div class="flex items-center space-x-4">
        <div class="text-sm text-gray-600">
          ç¸½è¨ˆ: <span class="font-semibold text-gray-800"><%= @action_pages.count %></span> å€‹ Action Page
        </div>
        <div class="text-sm text-yellow-600">
          Action è®Šæ›´: <span class="font-semibold text-yellow-800"><%= @action_pages.count { |ap| ap.changed_flag } %></span> å€‹
        </div>
        <div class="text-sm text-orange-600">
          Model è®Šæ›´: <span class="font-semibold text-orange-800"><%= @action_pages.count { |ap| ap.relate_models.any? { |rm| rm.changed_flag } } %></span> å€‹
        </div>
        <div class="text-sm text-gray-600">
          æ­£å¸¸: <span class="font-semibold text-gray-800"><%= @action_pages.count { |ap| !ap.changed_flag && !ap.relate_models.any? { |rm| rm.changed_flag } } %></span> å€‹
        </div>
      </div>
      <% if params[:filter] == 'changed' %>
        <div class="text-sm text-yellow-600 font-medium">
          ğŸ”„ ç›®å‰é¡¯ç¤ºï¼šåƒ…å·²è®Šæ›´çš„é …ç›®
        </div>
      <% end %>
    </div>
  </div>

  <!-- GitHub åˆ†ææ§åˆ¶å€ -->
  <div class="pt-2 pb-4">
    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">GitHub PR åˆ†æ</h3>
      <div class="flex items-center space-x-4 flex-wrap gap-2">
        <!-- é‡ç½® Flag æŒ‰éˆ•ï¼ˆç„¡æ—‹è½‰åœ–ç¤ºï¼Œç­‰å¾…æ™‚æ”¹ç‚ºå½ˆå‡ºè¦–çª—ï¼‰ -->
        <button
          id="reset-flags-btn"
          type="button"
          class="px-4 py-2 bg-red-600 text-black rounded-lg shadow-md hover:bg-red-700 hover:shadow-lg hover:scale-105 active:bg-red-800 active:scale-95 transition duration-200 text-sm font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
          onclick="resetFlags()">
          é‡ç½® Flag
        </button>
        
        <!-- Ownerã€PR Number è¼¸å…¥æ¡†å’Œé€å‡ºæŒ‰éˆ• -->
        <div class="flex items-center space-x-2 flex-wrap gap-2">
          <div class="flex items-center space-x-1">
            <label for="owner-input" class="text-sm text-gray-700 font-medium">Owner:</label>
            <input 
              type="text" 
              id="owner-input" 
              placeholder="ä¾‹å¦‚: AMASTek"
              class="border border-gray-300 rounded-lg px-3 py-2 w-32 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <span class="text-xs text-gray-500">å»ºè­°: 'AMASTek', 'amashrm'</span>
          </div>
          <div class="flex items-center space-x-1">
            <label for="pr-number-input" class="text-sm text-gray-700 font-medium">PR Number:</label>
            <input 
              type="text" 
              id="pr-number-input" 
              placeholder="ä¾‹å¦‚: 65"
              class="border border-gray-300 rounded-lg px-3 py-2 w-32 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <button 
              id="query-pr-btn"
              class="px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 hover:shadow-lg hover:scale-105 active:bg-blue-800 active:scale-95 transition duration-200 text-xs font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
              onclick="queryPrInfo()"
              title="æŸ¥è©¢ PR è³‡è¨Š">
              ğŸ”æŸ¥è©¢ PR è³‡è¨Š
            </button>
          </div>
          <!-- åˆ†æ PR æŒ‰éˆ•ï¼ˆç„¡æ—‹è½‰åœ–ç¤ºï¼Œç­‰å¾…æ™‚æ”¹ç‚ºå½ˆå‡ºè¦–çª—ï¼‰ -->
          <button
            id="update-flags-btn"
            type="button"
            class="px-4 py-2 bg-green-600 text-black rounded-lg shadow-md hover:bg-green-700 hover:shadow-lg hover:scale-105 active:bg-green-800 active:scale-95 transition duration-200 text-sm font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed"
            onclick="updateFlagsFromPr()">
            åˆ†æ PR
          </button>
        </div>
      </div>
      <!-- PR è³‡è¨Šé¡¯ç¤ºå€åŸŸ -->
      <div id="pr-info-display" class="hidden mt-3 p-3 bg-white rounded-lg border border-gray-300">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="text-sm font-semibold text-gray-800 mb-1" id="pr-title"></div>
            <div class="text-xs text-gray-500">
              <span id="pr-state"></span>
              <span class="mx-2">â€¢</span>
              <span id="pr-user"></span>
            </div>
          </div>
          <a id="pr-link" href="#" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 ml-2">
            æŸ¥çœ‹ PR â†’
          </a>
        </div>
      </div>
      <!-- è¨Šæ¯é¡¯ç¤ºå€åŸŸ -->
      <div id="message-indicator" class="hidden mt-3 text-sm font-medium"></div>
    </div>
  </div>

  <!-- ç­‰å¾…ä¸­å½ˆå‡ºè¦–çª—ï¼ˆåŒ¯å…¥/è™•ç†æ™‚é¡¯ç¤ºï¼Œå®Œæˆå¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰ -->
  <div id="waiting-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50" aria-hidden="true">
    <div class="bg-white rounded-xl shadow-2xl px-8 py-6 flex flex-col items-center gap-4 min-w-[200px]">
      <p id="waiting-modal-message" class="text-gray-800 font-medium">ç­‰å¾…ä¸­...</p>
      <p class="text-sm text-gray-500 animate-pulse">è«‹ç¨å€™</p>
    </div>
  </div>

  <!-- è¡¨æ ¼ -->
  <div class="pt-2">
    <table class="w-full border border-gray-300 border-collapse bg-white rounded-lg shadow-md table-fixed">
      <thead class="sticky top-[72px] z-10">
        <tr class="bg-gray-200 text-gray-700 uppercase text-sm shadow-md">
          <th class="px-4 py-3 border border-gray-300 w-[200px] break-words bg-gray-200">Management Page</th>
          <th class="px-4 py-3 border border-gray-300 w-[250px] break-words bg-gray-200">Action Page</th>
          <th class="px-4 py-3 border border-gray-300 w-[150px] break-words bg-gray-200">Relate Action</th>
          <th class="px-4 py-3 border border-gray-300 w-[150px] break-words bg-gray-200">Relate Model</th>
          <th class="px-4 py-3 border border-gray-300 w-[200px] break-words bg-gray-200">Select Column</th>
          <th class="px-4 py-3 border border-gray-300 w-[200px] break-words bg-gray-200">Modify Column</th>
          <th class="px-4 py-3 border border-gray-300 w-[150px] break-words bg-gray-200">Delete Column</th>
          <th class="px-4 py-3 border border-gray-300 w-[100px] break-words bg-gray-200">Status</th>
        </tr>
      </thead>
      <tbody>
          <% @management_pages.each do |management_page| %>
            <tr class="bg-blue-100 font-semibold">
              <td colspan="8" class="px-4 py-4 border border-gray-300 text-lg break-words"><%= management_page.name %></td>
            </tr>
            
            <% action_pages = @action_pages.select { |action_page| action_page[:management_page_id] == management_page.id } %>
            
            <% if action_pages&.any? %>
              <% action_pages.each do |action_page| %>
                <% 
                  # æª¢æŸ¥ action_page æˆ–ä»»ä½• relate_model æ˜¯å¦æœ‰ changed_flag
                  has_changed_action = action_page.changed_flag
                  has_changed_models = action_page.relate_models.any? { |rm| rm.changed_flag }
                  has_any_changes = has_changed_action || has_changed_models
                  
                  # æ ¹æ“šä»»ä½•è®Šæ›´æ±ºå®šè¡Œçš„æ¨£å¼
                  row_class = has_any_changes ? "bg-yellow-100 hover:bg-yellow-200 border-l-4 border-yellow-500" : "hover:bg-gray-100"
                %>
                <tr class="<%= row_class %>">
                  <td class="px-4 py-3 border border-gray-300 w-[200px]"></td>
                  <td class="px-4 py-3 border border-gray-300 w-[250px] text-blue-600 font-bold break-words">
                    <%= action_page.name %>
                    <% if has_changed_action %>
                      <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-200 text-yellow-800">
                        ğŸ”„ Action
                      </span>
                    <% end %>
                    <% if has_changed_models %>
                      <span class="ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-200 text-orange-800">
                        ğŸ“Š Model
                      </span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 border border-gray-300 w-[150px] break-words"><%= action_page.relate_action&.join(', ') %></td>
                  <td class="px-4 py-3 border border-gray-300 w-[150px] break-words"><%= action_page.relate_model&.join(', ') %></td>
                  <td class="px-4 py-3 border border-gray-300 w-[200px] break-words"><%= action_page.select_column&.join(", ") %></td>
                  <td class="px-4 py-3 border border-gray-300 w-[200px] break-words"><%= action_page.modify_column&.join(", ") %></td>
                  <td class="px-4 py-3 border border-gray-300 w-[150px] break-words"><%= action_page.delete_column&.join(", ") %></td>
                  <td class="px-4 py-3 border border-gray-300 w-[100px] break-words text-center">
                    <% if has_any_changes %>
                      <div class="flex flex-col space-y-1">
                        <% if has_changed_action %>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-200 text-yellow-800">
                            ğŸ”„ Action
                          </span>
                        <% end %>
                        <% if has_changed_models %>
                          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-200 text-orange-800">
                            ğŸ“Š Model
                          </span>
                        <% end %>
                      </div>
                    <% else %>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-600">
                        âœ“ æ­£å¸¸
                      </span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <!-- å¦‚æœæ²’æœ‰ Action Page -->
              <tr class="bg-gray-50">
                <td class="border border-gray-300"></td>
                <td colspan="7" class="px-4 py-3 border border-gray-300 text-center text-gray-500">No Action Pages</td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function showWaitingModal(message) {
    message = message || 'ç­‰å¾…ä¸­...';
    const modal = document.getElementById('waiting-modal');
    const msgEl = document.getElementById('waiting-modal-message');
    if (modal) modal.classList.remove('hidden');
    if (msgEl) msgEl.textContent = message;
  }

  function hideWaitingModal() {
    const modal = document.getElementById('waiting-modal');
    if (modal) modal.classList.add('hidden');
  }

  function resetLoadingIndicators() {
    hideWaitingModal();
    const resetBtn = document.getElementById('reset-flags-btn');
    const updateBtn = document.getElementById('update-flags-btn');
    const queryBtn = document.getElementById('query-pr-btn');
    if (resetBtn) resetBtn.disabled = false;
    if (updateBtn) updateBtn.disabled = false;
    if (queryBtn) {
      queryBtn.disabled = false;
      queryBtn.textContent = 'ğŸ”æŸ¥è©¢ PR è³‡è¨Š';
    }
  }

  function showMessage(message, isSuccess) {
    const messageEl = document.getElementById('message-indicator');
    messageEl.textContent = message;
    messageEl.className = isSuccess 
      ? 'mt-3 text-sm font-medium text-green-600' 
      : 'mt-3 text-sm font-medium text-red-600';
    messageEl.classList.remove('hidden');
  }

  function setButtonDisabled(btnId, disabled) {
    const btn = document.getElementById(btnId);
    if (btn) btn.disabled = disabled;
  }

  function resetFlags() {
    setButtonDisabled('reset-flags-btn', true);
    showWaitingModal('é‡ç½® Flag è™•ç†ä¸­...');

    fetch('<%= reset_flags_management_page_path(@company) %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      }
    })
    .then(response => response.json())
    .then(data => {
      hideWaitingModal();
      setButtonDisabled('reset-flags-btn', false);
      if (data.success) {
        showMessage('âœ… ' + data.message, true);
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showMessage('âŒ ' + (data.error || 'æ“ä½œå¤±æ•—'), false);
      }
    })
    .catch(error => {
      hideWaitingModal();
      setButtonDisabled('reset-flags-btn', false);
      showMessage('âŒ éŒ¯èª¤: ' + error.message, false);
    });
  }

  function updateFlagsFromPr() {
    const prNumber = document.getElementById('pr-number-input').value.trim();
    const owner = document.getElementById('owner-input').value.trim();
    
    if (!prNumber) {
      showMessage('âŒ è«‹è¼¸å…¥ PR Number', false);
      return;
    }
    
    setButtonDisabled('update-flags-btn', true);
    showWaitingModal('åˆ†æ PR ä¸­...');

    fetch('<%= update_flags_from_pr_management_page_path(@company) %>', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      },
      body: JSON.stringify({
        owner: owner || 'AMASTek',
        pr_number: prNumber
      })
    })
    .then(response => response.json())
    .then(data => {
      hideWaitingModal();
      setButtonDisabled('update-flags-btn', false);
      if (data.success) {
        showMessage('âœ… ' + data.message, true);
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showMessage('âŒ ' + (data.error || 'æ“ä½œå¤±æ•—'), false);
      }
    })
    .catch(error => {
      hideWaitingModal();
      setButtonDisabled('update-flags-btn', false);
      showMessage('âŒ éŒ¯èª¤: ' + error.message, false);
    });
  }

  function queryPrInfo() {
    const prNumber = document.getElementById('pr-number-input').value.trim();
    const owner = document.getElementById('owner-input').value.trim();
    const btn = document.getElementById('query-pr-btn');
    const prInfoDisplay = document.getElementById('pr-info-display');
    
    if (!prNumber) {
      showMessage('âŒ è«‹å…ˆè¼¸å…¥ PR Number', false);
      return;
    }
    
    btn.disabled = true;
    showWaitingModal('æŸ¥è©¢ PR è³‡è¨Šä¸­...');

    const url = new URL('<%= get_pr_info_management_page_path(@company) %>', window.location.origin);
    url.searchParams.append('owner', owner || 'AMASTek');
    url.searchParams.append('pr_number', prNumber);
    
    fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('pr-title').textContent = data.title;
        document.getElementById('pr-state').textContent = `ç‹€æ…‹: ${data.state}`;
        document.getElementById('pr-user').textContent = `ä½œè€…: ${data.user || 'N/A'}`;
        document.getElementById('pr-link').href = data.html_url;
        prInfoDisplay.classList.remove('hidden');
      } else {
        showMessage('âŒ ' + (data.error || 'æŸ¥è©¢å¤±æ•—'), false);
        prInfoDisplay.classList.add('hidden');
      }
    })
    .catch(error => {
      showMessage('âŒ éŒ¯èª¤: ' + error.message, false);
      prInfoDisplay.classList.add('hidden');
    })
    .finally(() => {
      hideWaitingModal();
      btn.disabled = false;
    });
  }

  document.addEventListener('turbo:before-cache', resetLoadingIndicators);
  document.addEventListener('turbo:load', resetLoadingIndicators);

  document.getElementById('pr-number-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') updateFlagsFromPr();
  });

  document.getElementById('owner-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') updateFlagsFromPr();
  });
</script>
